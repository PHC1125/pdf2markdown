<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PDF → Markdown Converter</title>
<style>
    :root{
        --bg:#10151c;
        --fg:#e8f2ff;
        --accent:#4dc6ff;
        --card:#18202b;
        --radius:8px;
        --font:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    *{box-sizing:border-box;}
    body{
        margin:0;
        padding:2rem 1rem;
        font-family:var(--font);
        background:var(--bg);
        color:var(--fg);
        display:flex;
        flex-direction:column;
        align-items:center;
        min-height:100vh;
        gap:2rem;
    }
    h1{margin:0;font-size:clamp(1.5rem,5vw,2.3rem);text-align:center;}
    .card{
        background:var(--card);
        padding:1.5rem;
        border-radius:var(--radius);
        width:100%;
        max-width:42rem;
        display:flex;
        flex-direction:column;
        gap:1rem;
    }
    label,input,button,textarea{
        font:inherit;
        width:100%;
    }
    input[type="file"]{
        padding:.6rem;
        background:#fff1;
        border:1px solid #fff3;
        border-radius:var(--radius);
        color:var(--fg);
    }
    button{
        cursor:pointer;
        background:var(--accent);
        color:#00111d;
        border:none;
        padding:.75rem 1rem;
        font-weight:600;
        border-radius:var(--radius);
        transition:background .2s;
    }
    button:disabled{
        opacity:.4;
        cursor:not-allowed;
    }
    textarea{
        height:40vh;
        resize:vertical;
        padding:1rem;
        border-radius:var(--radius);
        border:1px solid #fff3;
        background:#0004;
        color:var(--fg);
    }
    footer{font-size:.8rem;opacity:.6;text-align:center;}
    a{color:var(--accent);}
</style>
</head>
<body>
    <h1>PDF → Markdown Converter</h1>

    <div class="card">
        <label>
            Select PDF file
            <input type="file" id="pdfFile" accept="application/pdf">
        </label>

        <button id="convertBtn" disabled>Convert to Markdown</button>

        <textarea id="output" placeholder="Markdown will appear here…" spellcheck="false"></textarea>
        <button id="downloadBtn" disabled>Download .md</button>
    </div>

    <footer>Powered by <a href="https://github.com/mozilla/pdf.js/" target="_blank">PDF.js</a>. All work happens locally in your browser.</footer>

<!-- PDF.js (worker is fetched automatically) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>

<script type="module">
const fileInput   = document.getElementById('pdfFile');
const convertBtn  = document.getElementById('convertBtn');
const downloadBtn = document.getElementById('downloadBtn');
const outputArea  = document.getElementById('output');

let currentMarkdown = '';
let currentFilename = 'document.md';

/* ---------- helpers ---------- */
function sanitizeFilename(name){
    return name.replace(/\.[^/.]+$/,'').replace(/[^-\w ]+/g,'').trim() || 'document';
}
function saveFile(filename, text){
    const blob = new Blob([text],{type:'text/markdown'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

/* ---------- PDF → MD pipeline ---------- */
async function pdfToMarkdown(arrayBuffer){
    // Configure PDF.js
    const loadingTask = pdfjsLib.getDocument({data:arrayBuffer});
    const pdf = await loadingTask.promise;
    const total  = pdf.numPages;
    let markdown = '';

    for(let i=1;i<=total;i++){
        const page  = await pdf.getPage(i);
        const textC = await page.getTextContent({normalizeWhitespace:true});

        // join items keeping original order
        const pageLines = textC.items.map(it=>it.str.trim());

        // naive heuristics: blank line between paragraphs,
        // detect headings by ALL CAPS or big font
        let lastLineBlank = false;
        for(const item of pageLines){
            if(!item){
                if(!lastLineBlank){
                    markdown += '\n';
                    lastLineBlank = true;
                }
                continue;
            }
            const heading = /^[A-Z0-9 ]{5,}$/.test(item);
            if(heading) markdown += `\n## ${item}\n`;
            else markdown += item + ' ';
            lastLineBlank = false;
        }
        markdown += '\n\n'; // page delimiter
    }

    // tidy whitespace
    markdown = markdown.replace(/[ \t]+\n/g,'\n')       // trailing spaces
                       .replace(/\n{3,}/g,'\n\n')       // max double blank lines
                       .trim() + '\n';

    return markdown;
}

/* ---------- UI bindings ---------- */
fileInput.addEventListener('change', () => {
    convertBtn.disabled = !fileInput.files.length;
    downloadBtn.disabled = true;
    outputArea.value = '';
});

convertBtn.addEventListener('click', async () => {
    const file = fileInput.files[0];
    if(!file) return;

    convertBtn.disabled = true;
    convertBtn.textContent = 'Converting…';

    const arrayBuffer = await file.arrayBuffer();
    try{
        currentMarkdown = await pdfToMarkdown(arrayBuffer);
        currentFilename = sanitizeFilename(file.name) + '.md';
        outputArea.value = currentMarkdown;
        downloadBtn.disabled = false;
    }catch(err){
        alert('Failed to convert PDF:\n' + err.message);
        console.error(err);
    }finally{
        convertBtn.textContent = 'Convert to Markdown';
        convertBtn.disabled = false;
    }
});

downloadBtn.addEventListener('click', () => {
    if(currentMarkdown) saveFile(currentFilename, currentMarkdown);
});
</script>
</body>
</html>
